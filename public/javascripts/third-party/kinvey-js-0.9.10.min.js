/*!
 * Copyright (c) 2012 Kinvey, Inc. All rights reserved.
 *
 * Licensed to Kinvey, Inc. under one or more contributor
 * license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright
 * ownership.  Kinvey, Inc. licenses this file to you under the
 * Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License.  You
 * may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
(function(undefined){var b=this,c;"undefined"!=typeof exports?c=exports:c=b.Kinvey={};var d=Object.defineProperty(function(){},"extend",{value:function(a,b){var c=a&&a.hasOwnProperty("constructor")?a.constructor:this,d=function(){c.apply(this,arguments)};d.prototype=function(a,b){return Object.getOwnPropertyNames(b).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))}),a}(Object.create(this.prototype),a||{});if(b)for(var e in b)b.hasOwnProperty(e)&&(d[e]=b[e]);return Object.defineProperty(d,"extend",Object.getOwnPropertyDescriptor(this,"extend")),d}}),e=function(a,b){return b||(b=function(){}),b.bind?b.bind(a):function(){return b.apply(a,arguments)}},f=function(){var a={};return Array.prototype.slice.call(arguments,0).forEach(function(b){for(var c in b)a[c]=b[c]}),a},g={get:function(a){var b=localStorage.getItem(a);return b?JSON.parse(b):null},set:function(a,b){localStorage.setItem(a,JSON.stringify(b))},remove:function(a){localStorage.removeItem(a)}},h=function(){var a=function(a){return btoa(a)},b=function(){if(null!==c.masterSecret)return"Basic "+this._base64(c.appKey+":"+c.masterSecret);var a=c.getCurrentUser();return null!==a?"Kinvey "+a.getToken():"Basic "+this._base64(c.appKey+":"+c.appSecret)},d=function(){var a=navigator.userAgent.toLowerCase(),b=/(chrome)\/([\w]+)/,c=/(safari)\/([\w.]+)/,d=/(firefox)\/([\w.]+)/,e=/(opera)(?:.*version)?[ \/]([\w.]+)/,f=/(msie) ([\w.]+)/i,g=b.exec(a)||c.exec(a)||d.exec(a)||e.exec(a)||f.exec(a)||[];return[window.cordova?"phonegap":navigator.platform,g[1]||navigator.appName,g[2]||0,0].map(function(a){return a.toString().toLowerCase().replace(" ","_")}).join(" ")},g=function(a,b,d,g){g||(g={}),"undefined"!=typeof g.timeout||(g.timeout=this.options.timeout),g.success||(g.success=this.options.success),g.error||(g.error=this.options.error);if(null===c.getCurrentUser()&&c.Store.AppData.USER_API!==this.api&&null===c.masterSecret)return c.User.create({},f(g,{success:e(this,function(){this._send(a,b,d,g)})}));b=c.HOST+b;var h={Accept:"application/json, text/javascript",Authorization:this._getAuth(),"X-Kinvey-API-Version":c.API_VERSION,"X-Kinvey-Device-Information":this._getDeviceInfo()};d&&(h["Content-Type"]="application/json; charset=utf-8"),"GET"===a&&"undefined"!=typeof window&&window.location&&(h["X-Kinvey-Origin"]=window.location.protocol+"//"+window.location.host),this._xhr(a,b,d,f(g,{headers:h,success:function(a,b){a=a?JSON.parse(a):null,g.success(a,b)},error:function(a,b){try{a=JSON.parse(a)}catch(d){var e={abort:"The request was aborted",error:"The request failed",timeout:"The request timed out"};a={error:c.Error.REQUEST_FAILED,description:e[a]||e.error,debug:""}}g.error(a,b)}}))},h=function(a,b,c,d){d||(d={}),d.headers||(d.headers={}),"undefined"!=typeof d.timeout||(d.timeout=this.options.timeout),d.success||(d.success=this.options.success),d.error||(d.error=this.options.error);var e=new XMLHttpRequest;e.open(a,b),e.timeout=d.timeout;for(var f in d.headers)d.headers.hasOwnProperty(f)&&e.setRequestHeader(f,d.headers[f]);e.onload=function(){2===parseInt(this.status/100,10)||304===this.status?d.success(this.responseText,{network:!0}):d.error(this.responseText,{network:!0})},e.onabort=e.onerror=e.ontimeout=function(a){d.error(a.type,{network:!0})},e.send(c)};return function(){return this._base64=a,this._getAuth=b,this._getDeviceInfo=d,this._send=g,this._xhr=h,this}}(),i=null;c.API_VERSION=2,c.HOST="https://baas.kinvey.com",c.SDK_VERSION="0.9.10",c.getCurrentUser=function(){return i},c.init=function(a){a||(a={});if(null==a.appKey)throw new Error("appKey must be defined");if(null==a.appSecret&&null==a.masterSecret)throw new Error("appSecret or masterSecret must be defined");c.appKey=a.appKey,c.appSecret=a.appSecret||null,c.masterSecret=a.masterSecret||null,c.User._restore(),a.sync&&c.Sync&&c.Sync.application()},c.ping=function(a){(new c.Store.AppData(null)).query(null,a)},c.setCurrentUser=function(a){i=a},c.Error={DATABASE_ERROR:"DatabaseError",NO_NETWORK:"NoNetwork",OPERATION_DENIED:"OperationDenied",REQUEST_FAILED:"RequestFailed",RESPONSE_PROBLEM:"ResponseProblem",ENTITY_NOT_FOUND:"EntityNotFound",COLLECTION_NOT_FOUND:"CollectionNotFound",APP_NOT_FOUND:"AppNotFound",USER_NOT_FOUND:"UserNotFound",BLOB_NOT_FOUND:"BlobNotFound",INVALID_CREDENTIALS:"InvalidCredentials",KINVEY_INTERNAL_ERROR_RETRY:"KinveyInternalErrorRetry",KINVEY_INTERNAL_ERROR_STOP:"KinveyInternalErrorStop",USER_ALREADY_EXISTS:"UserAlreadyExists",USER_UNAVAILABLE:"UserUnavailable",DUPLICATE_END_USERS:"DuplicateEndUsers",INSUFFICIENT_CREDENTIALS:"InsufficientCredentials",WRITES_TO_COLLECTION_DISALLOWED:"WritesToCollectionDisallowed",INDIRECT_COLLECTION_ACCESS_DISALLOWED:"IndirectCollectionAccessDisallowed",APP_PROBLEM:"AppProblem",PARAMETER_VALUE_OUT_OF_RANGE:"ParameterValueOutOfRange",CORS_DISABLED:"CORSDisabled",INVALID_QUERY_SYNTAX:"InvalidQuerySyntax",MISSING_QUERY:"MissingQuery",JSON_PARSE_ERROR:"JSONParseError",MISSING_REQUEST_HEADER:"MissingRequestHeader",INCOMPLETE_REQUEST_BODY:"IncompleteRequestBody",MISSING_REQUEST_PARAMETER:"MissingRequestParameter",INVALID_IDENTIFIER:"InvalidIdentifier",BAD_REQUEST:"BadRequest",FEATURE_UNAVAILABLE:"FeatureUnavailable",API_VERSION_NOT_IMPLEMENTED:"APIVersionNotImplemented",API_VERSION_NOT_AVAILABLE:"APIVersionNotAvailable",INPUT_VALIDATION_FAILED:"InputValidationFailed",BLruntimeError:"BLruntimeError"},c.Entity=d.extend({ATTR_ID:"_id",map:{},constructor:function(a,b,d){if(null==b)throw new Error("Collection must not be null");this.collection=b,this.metadata=null,d||(d={}),this.store=c.Store.factory(d.store,this.collection,d.options),d.map&&(this.map=d.map),this.attr=a?this._parseAttr(a):{},this._pending=!1},destroy:function(a){a||(a={}),this.store.remove(this.toJSON(),f(a,{success:e(this,function(b,c){a.success&&a.success(this,c)})}))},get:function(a){if(null==a)throw new Error("Key must not be null");var b=this.attr[a];return null!=b?b:null},getId:function(){return this.get(this.ATTR_ID)},getMetadata:function(){return this.metadata||(this.metadata=new c.Metadata(this.attr)),this.metadata},isNew:function(){return null===this.getId()},load:function(a,b){if(null==a)throw new Error("Id must not be null");b||(b={}),this.store.query(a,f(b,{success:e(this,function(a,c){this.attr=this._parseAttr(a),this.metadata=null,b.success&&b.success(this,c)})}))},save:function(a){a||(a={});if(this._pending&&a._ref){this._pending=!1,a.error({error:c.Error.OPERATION_DENIED,message:"Circular reference detected, aborting save",debug:""},{});return}this._pending=!0,this._saveAttr(this.attr,{success:e(this,function(b){this.store.save(this.toJSON(),f(a,{success:e(this,function(c,d){this._pending=!1,this.attr=f(this._parseAttr(c),b),this.metadata=null,a.success&&a.success(this,d)}),error:e(this,function(b,c){this._pending=!1,a.error&&a.error(b,c)})}))}),error:e(this,function(b,c){this._pending=!1,a.error&&a.error(b,c)}),_ref:!0})},set:function(a,b){if(null==a)throw new Error("Key must not be null");this.attr[a]=this._parse(a,b)},setId:function(a){if(null==a)throw new Error("Id must not be null");this.set(this.ATTR_ID,a)},setMetadata:function(a){if(!a||a instanceof c.Metadata)this.metadata=a||null;else throw new Error("Metadata must be an instanceof Kinvey.Metadata")},toJSON:function(a){var b=this._flattenAttr(this.attr);return this.metadata&&(b._acl=this.metadata.toJSON()._acl),b},unset:function(a){delete this.attr[a]},_flatten:function(a){return a instanceof Object&&(a instanceof c.Entity?a={_type:"KinveyRef",_collection:a.collection,_id:a.getId()}:a instanceof Array?a=a.map(e(this,function(a){return this._flatten(a)})):a=this._flattenAttr(a)),a},_flattenAttr:function(a){var b={};return Object.keys(a).forEach(e(this,function(c){b[c]=this._flatten(a[c])})),b},_parse:function(a,b){if(b instanceof Object&&!(b instanceof c.Entity))if("KinveyRef"===b._type){if(b._obj){var d=this.map[a]||c.Entity,f={store:this.store.type,options:this.store.options};b=new d(b._obj,b._collection,f)}}else b instanceof Array?b=b.map(e(this,function(b){return this._parse(a,b)})):b=this._parseAttr(b,a);return b},_parseAttr:function(a,b){var c=f(a);return Object.keys(a).forEach(e(this,function(d){c[d]=this._parse((b?b+".":"")+d,a[d])})),c},_save:function(a,b){if(a instanceof Object){if(a instanceof c.Entity)return a.getMetadata().hasWritePermissions()?a.save(b):b.success(a);if(a instanceof Array){var d=0,g=e(this,function(){var c=a[d];c?this._save(c,f(b,{success:function(b){a[d++]=b,g()}})):b.success(a)});return g()}return this._saveAttr(a,b)}b.success(a)},_saveAttr:function(a,b){var c=Object.keys(a),d=0,g=e(this,function(){var e=c[d++];e?this._save(a[e],f(b,{success:function(b){a[e]=b,g()}})):b.success(a)});g()}}),c.Collection=d.extend({list:[],entity:c.Entity,constructor:function(a,b){if(null==a)throw new Error("Name must not be null");this.name=a,b||(b={}),this.setQuery(b.query||new c.Query),this.store=c.Store.factory(b.store,this.name,b.options)},aggregate:function(a,b){if(a instanceof c.Aggregation)a.setQuery(this.query),this.store.aggregate(a.toJSON(),b);else throw new Error("Aggregation must be an instanceof Kinvey.Aggregation")},clear:function(a){a||(a={}),this.store.removeWithQuery(this.query.toJSON(),f(a,{success:e(this,function(b,c){this.list=[],a.success&&a.success(c)})}))},count:function(a){a||(a={});var b=new c.Aggregation;b.setInitial({count:0}),b.setReduce(function(a,b){b.count+=1}),b.setQuery(this.query),this.store.aggregate(b.toJSON(),f(a,{success:function(b,c){a.success&&a.success(b[0].count,c)}}))},fetch:function(a){a||(a={}),this.store.queryWithQuery(this.query.toJSON(),f(a,{success:e(this,function(b,c){this.list=[],b.forEach(e(this,function(a){var b={store:this.store.name,options:this.store.options};this.list.push(new this.entity(a,this.name,b))})),a.success&&a.success(this.list,c)})}))},setQuery:function(a){if(!a||a instanceof c.Query)this.query=a||new c.Query;else throw new Error("Query must be an instanceof Kinvey.Query")}});var j=function(){return"Kinvey."+c.appKey};c.User=c.Entity.extend({ATTR_USERNAME:"username",ATTR_PASSWORD:"password",token:null,constructor:function(a){c.Entity.prototype.constructor.call(this,a,"user")},destroy:function(a){a||(a={}),c.Entity.prototype.destroy.call(this,f(a,{success:e(this,function(b,c){this._logout(),a.success&&a.success(this,c)})}))},getIdentity:function(){return this.get("_socialIdentity")},getToken:function(){return this.token},getUsername:function(){return this.get(this.ATTR_USERNAME)},login:function(a,b,c){this._doLogin({username:a,password:b},c||{})},loginWithFacebook:function(a,b,d){b||(b={}),b._socialIdentity={facebook:{access_token:a}},d||(d={}),this._doLogin(b,f(d,{error:e(this,function(a,e){if(c.Error.USER_NOT_FOUND===a.error)return this.attr=b,c.User.create(b,f(d,{_target:this}));d.error&&d.error(a,e)})}))},logout:function(a){a||(a={});if(!this.isLoggedIn){a.success&&a.success({});return}this.store.logout({},f(a,{success:e(this,function(b,c){this._logout(),a.success&&a.success(c)})}))},save:function(a){a||(a={});if(!this.isLoggedIn){a.error&&a.error({code:c.Error.OPERATION_DENIED,description:"This operation is not allowed",debug:"Cannot save a user which is not logged in."},{});return}c.Entity.prototype.save.call(this,f(a,{success:e(this,function(b,c){this._saveToDisk(),a.success&&a.success(this,c)})}))},_deleteFromDisk:function(){g.remove(j())},_doLogin:function(a,b){var d=c.getCurrentUser();if(null!==d){d.logout(f(b,{success:e(this,function(){this._doLogin(a,b)})}));return}this.store.login(a,f(b,{success:e(this,function(a,c){var d=a._kmd.authtoken;delete a._kmd.authtoken,this.attr=this._parseAttr(a),this._login(d),b.success&&b.success(this,c)})}))},_login:function(a){null==c.masterSecret&&(c.setCurrentUser(this),this.isLoggedIn=!0,this.token=a,this._saveToDisk())},_logout:function(){null==c.masterSecret&&(c.setCurrentUser(null),this.isLoggedIn=!1,this.token=null,this._deleteFromDisk())},_saveToDisk:function(){g.set(j(),{token:this.token,user:this.toJSON()})}},{create:function(a,b){b||(b={});var d=c.getCurrentUser();if(null!==d){d.logout(f(b,{success:function(){c.User.create(a,b)}}));return}var g=b._target||new c.User(a);return c.Entity.prototype.save.call(g,f(b,{success:e(g,function(a,c){var d=this.attr._kmd.authtoken;delete this.attr._kmd.authtoken,this._login(d),b.success&&b.success(this,c)})})),g},init:function(a){a||(a={});var b=c.getCurrentUser();return null!==b?(a.success&&a.success(b,{}),b):c.User.create({},a)},_restore:function(){if(null!==c.getCurrentUser())return;var a=g.get(j());null!==a&&null!=a.token&&null!=a.user&&(new c.User(a.user))._login(a.token)}}),c.UserCollection=c.Collection.extend({entity:c.User,constructor:function(a){c.Collection.prototype.constructor.call(this,"user",a)},clear:function(a){a&&a.error&&a.error({code:c.Error.OPERATION_DENIED,description:"This operation is not allowed",debug:""})}}),c.Metadata=d.extend({constructor:function(a){a||(a={}),this.acl=a._acl||{},this.kmd=a._kmd||{}},addReader:function(a){this.acl.r||(this.acl.r=[]),-1===this.acl.r.indexOf(a)&&this.acl.r.push(a)},addWriter:function(a){this.acl.w||(this.acl.w=[]),-1===this.acl.w.indexOf(a)&&this.acl.w.push(a)},getReaders:function(){return this.acl.r||[]},getWriters:function(){return this.acl.w||[]},isOwner:function(){var a=this.acl.creator,b=c.getCurrentUser();return a?!!b&&a===b.getId():!0},lastModified:function(){return this.kmd.lmt||null},hasWritePermissions:function(){if(this.isOwner()||this.isGloballyWritable())return!0;var a=c.getCurrentUser();return a&&this.acl.w?-1!==this.acl.w.indexOf(a.getId()):!1},isGloballyReadable:function(){return!!this.acl.gr},isGloballyWritable:function(){return!!this.acl.gw},removeReader:function(a){if(this.acl.r){var b=this.acl.r.indexOf(a);-1!==b&&this.acl.r.splice(b,1)}},removeWriter:function(a){if(this.acl.w){var b=this.acl.w.indexOf(a);-1!==b&&this.acl.w.splice(b,1)}},setGloballyReadable:function(a){this.acl.gr=!!a},setGloballyWritable:function(a){this.acl.gw=!!a},toJSON:function(){return{_acl:this.acl,_kmd:this.kmd}}}),c.Query=d.extend({currentKey:null,constructor:function(a){this.builder=a||c.Query.factory()},all:function(a){if(a instanceof Array)return this._set(c.Query.ALL,a),this;throw new Error("Argument must be of type Array")},and:function(a){return this._set(c.Query.AND,a.builder,!0),this},equal:function(a){return this._set(c.Query.EQUAL,a),this},exist:function(a){return a="undefined"!=typeof a?!!a:!0,this._set(c.Query.EXIST,a),this},greaterThan:function(a){return this._set(c.Query.GREATER_THAN,a),this},greaterThanEqual:function(a){return this._set(c.Query.GREATER_THAN_EQUAL,a),this},in_:function(a){if(a instanceof Array)return this._set(c.Query.IN,a),this;throw new Error("Argument must be of type Array")},lessThan:function(a){return this._set(c.Query.LESS_THAN,a),this},lessThanEqual:function(a){return this._set(c.Query.LESS_THAN_EQUAL,a),this},nearSphere:function(a,b){if(a instanceof Array&&2===a.length)return this._set(c.Query.NEAR_SPHERE,{point:a,maxDistance:"undefined"!=typeof b?b:null}),this;throw new Error("Point must be of type Array[lng, lat]")},notEqual:function(a){return this._set(c.Query.NOT_EQUAL,a),this},notIn:function(a){if(a instanceof Array)return this._set(c.Query.NOT_IN,a),this;throw new Error("Argument must be of type Array")},on:function(a){return this.currentKey=a,this},or:function(a){return this._set(c.Query.OR,a.builder,!0),this},regex:function(a){return this._set(c.Query.REGEX,a),this},reset:function(){return this.builder.reset(),this},setLimit:function(a){return this.builder.setLimit(a),this},setSkip:function(a){return this.builder.setSkip(a),this},size:function(a){return this._set(c.Query.SIZE,a),this},sort:function(a){return null!==a&&(a=a||c.Query.ASC),this.builder.setSort(this.currentKey,a),this},toJSON:function(){return this.builder.toJSON()},withinBox:function(a){if(a instanceof Array&&2===a.length)return this._set(c.Query.WITHIN_BOX,a),this;throw new Error("Points must be of type Array[[lng, lat], [lng, lat]]")},withinCenterSphere:function(a,b){if(a instanceof Array&&2===a.length)return this._set(c.Query.WITHIN_CENTER_SPHERE,{center:a,radius:b}),this;throw new Error("Point must be of type Array[lng, lat]")},withinPolygon:function(a){if(a instanceof Array)return this._set(c.Query.WITHIN_POLYGON,a),this;throw new Error("Points must be of type Array[[lng, lat], ...]")},_set:function(a,b,c){if(null===this.currentKey&&!c)throw new Error("Key under condition must not be null");this.builder.addCondition(this.currentKey,a,b)}},{EQUAL:16,EXIST:17,LESS_THAN:18,LESS_THAN_EQUAL:19,GREATER_THAN:20,GREATER_THAN_EQUAL:21,NOT_EQUAL:22,REGEX:23,NEAR_SPHERE:1024,WITHIN_BOX:1025,WITHIN_CENTER_SPHERE:1026,WITHIN_POLYGON:1027,MAX_DISTANCE:1028,IN:2048,NOT_IN:2049,AND:4096,OR:4097,ALL:8192,SIZE:8193,ASC:16384,DESC:16385,factory:function(){return new c.Query.MongoBuilder}}),c.Query.MongoBuilder=d.extend({limit:null,skip:null,sort:null,query:null,constructor:function(){},addCondition:function(a,b,d){switch(b){case c.Query.EQUAL:this._set(a,d);break;case c.Query.EXIST:this._set(a,{$exists:d});break;case c.Query.LESS_THAN:this._set(a,{$lt:d});break;case c.Query.LESS_THAN_EQUAL:this._set(a,{$lte:d});break;case c.Query.GREATER_THAN:this._set(a,{$gt:d});break;case c.Query.GREATER_THAN_EQUAL:this._set(a,{$gte:d});break;case c.Query.NOT_EQUAL:this._set(a,{$ne:d});break;case c.Query.REGEX:var e=new RegExp(d),f=(e.global?"g":"")+(e.ignoreCase?"i":"")+(e.multiline?"m":"");this._set(a,{$regex:e.source,$options:f});break;case c.Query.NEAR_SPHERE:var g={$nearSphere:d.point};d.maxDistance&&(g.$maxDistance=d.maxDistance),this._set(a,g);break;case c.Query.WITHIN_BOX:this._set(a,{$within:{$box:d}});break;case c.Query.WITHIN_CENTER_SPHERE:this._set(a,{$within:{$centerSphere:[d.center,d.radius]}});break;case c.Query.WITHIN_POLYGON:this._set(a,{$within:{$polygon:d}});break;case c.Query.IN:this._set(a,{$in:d});break;case c.Query.NOT_IN:this._set(a,{$nin:d});break;case c.Query.AND:if(!(d instanceof c.Query.MongoBuilder))throw new Error("Query must be of type Kinvey.Query.Mongobuilder");this.query={$and:[this.query||{},d.query||{}]};break;case c.Query.OR:if(!(d instanceof c.Query.MongoBuilder))throw new Error("Query must be of type Kinvey.Query.Mongobuilder");this.query={$or:[this.query||{},d.query||{}]};break;case c.Query.ALL:this._set(a,{$all:d});break;case c.Query.SIZE:this._set(a,{$size:d});break;default:throw new Error("Condition "+b+" is not supported")}},reset:function(){this.query=null},setLimit:function(a){this.limit=a},setSkip:function(a){this.skip=a},setSort:function(a,b){if(null==b){this.sort=null;return}var d=c.Query.ASC===b?1:-1;this.sort={},this.sort[a]=d},toJSON:function(){var a={};return this.limit&&(a.limit=this.limit),this.skip&&(a.skip=this.skip),this.sort&&(a.sort=this.sort),this.query&&(a.query=this.query),a},_set:function(a,b){this.query||(this.query={});if(!(b instanceof Object)){this.query[a]=b;return}this.query[a]instanceof Object||(this.query[a]={});for(var c in b)b.hasOwnProperty(c)&&(this.query[a][c]=b[c])}}),c.Aggregation=d.extend({constructor:function(a){this.builder=a||c.Aggregation.factory()},on:function(a){return this.builder.on(a),this},setFinalize:function(a){this.builder.setFinalize(a)},setInitial:function(a){return this.builder.setInitial(a),this},setQuery:function(a){if(!a||a instanceof c.Query)return this.builder.setQuery(a),this;throw new Error("Query must be an instanceof Kinvey.Query")},setReduce:function(a){return this.builder.setReduce(a),this},toJSON:function(){return this.builder.toJSON()}},{factory:function(){return new c.Aggregation.MongoBuilder}}),c.Aggregation.MongoBuilder=d.extend({finalize:function(){},initial:{count:0},keys:null,reduce:function(a,b){b.count++},query:null,constructor:function(){this.keys={}},on:function(a){this.keys[a]=!0},setFinalize:function(a){this.finalize=a},setInitial:function(a){this.initial=a},setQuery:function(a){return this.query=a,this},setReduce:function(a){this.reduce=a},toJSON:function(){var a={finalize:this.finalize.toString(),initial:this.initial,key:this.keys,reduce:this.reduce.toString()},b=this.query&&this.query.toJSON().query;return b&&(a.condition=b),a}}),c.Store={APPDATA:"appdata",CACHED:"cached",OFFLINE:"offline",factory:function(a,b,d){return c.Store.CACHED===a?new c.Store.Cached(b,d):c.Store.OFFLINE===a?new c.Store.Offline(b,d):new c.Store.AppData(b,d)}},c.Store.AppData=d.extend({name:c.Store.APPDATA,options:{timeout:1e4,success:function(){},error:function(){}},constructor:function(a,b){this.api=c.Store.AppData.USER_API===a?c.Store.AppData.USER_API:c.Store.AppData.APPDATA_API,this.collection=a,b&&this.configure(b)},aggregate:function(a,b){var c=this._getUrl({id:"_group"});this._send("POST",c,JSON.stringify(a),b)},configure:function(a){"undefined"!=typeof a.timeout&&(this.options.timeout=a.timeout),a.success&&(this.options.success=a.success),a.error&&(this.options.error=a.error)},login:function(a,b){var c=this._getUrl({id:"login"});this._send("POST",c,JSON.stringify(a),b)},logout:function(a,b){var c=this._getUrl({id:"_logout"});this._send("POST",c,null,b)},query:function(a,b){b||(b={});var c=this._getUrl({id:a,resolve:b.resolve});this._send("GET",c,null,b)},queryWithQuery:function(a,b){b||(b={});var c=this._getUrl({query:a,resolve:b.resolve});this._send("GET",c,null,b)},remove:function(a,b){var c=this._getUrl({id:a._id});this._send("DELETE",c,null,b)},removeWithQuery:function(a,b){var c=this._getUrl({query:a});this._send("DELETE",c,null,b)},save:function(a,b){var c=a._id?"PUT":"POST",d=this._getUrl({id:a._id});this._send(c,d,JSON.stringify(a),b)},_encode:function(a){return a instanceof Object&&(a=JSON.stringify(a)),encodeURIComponent(a)},_getUrl:function(a){var b="/"+this.api+"/"+c.appKey+"/";c.Store.AppData.APPDATA_API===this.api&&null!=this.collection&&(b+=this.collection+"/"),a.id&&(b+=a.id);var d=[];return null!=a.query&&(d.push("query="+this._encode(a.query.query||{})),a.query.limit&&d.push("limit="+this._encode(a.query.limit)),a.query.skip&&d.push("skip="+this._encode(a.query.skip)),a.query.sort&&d.push("sort="+this._encode(a.query.sort))),a.resolve&&d.push("resolve="+a.resolve.join(",")),d.push("_="+(new Date).getTime()),b+"?"+d.join("&")}},{APPDATA_API:"appdata",USER_API:"user"}),h.call(c.Store.AppData.prototype);var k=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,l=window.IDBTransaction||window.webkitIDBTransaction||{},m=d.extend({constructor:function(a){this.name="Kinvey."+c.appKey,this.collection=a},aggregate:function(a,b){b=this._options(b),this._transaction(m.AGGREGATION_STORE,m.READ_ONLY,e(this,function(d){var e=this._getKey(a),f=d.objectStore(m.AGGREGATION_STORE).get(e);d.oncomplete=function(){var a=f.result;a?b.success(a.response,{cached:!0}):b.error(c.Error.DATABASE_ERROR,"Aggregation is not in database.")},d.onabort=d.onerror=function(){b.error(c.Error.DATABASE_ERROR,d.error||"Failed to execute transaction.")}}),b.error)},query:function(a,b){b=this._options(b),this._transaction(this.collection,m.READ_ONLY,e(this,function(d){var f=d.objectStore(this.collection).get(a);d.oncomplete=e(this,function(){var a=f.result;if(a){if(b.resolve&&b.resolve.length)return this._resolve(a,b.resolve,function(){b.success(a,{cached:!0})});b.success(a,{cached:!0})}else b.error(c.Error.ENTITY_NOT_FOUND,"This entity could not be found.")}),d.onabort=d.onerror=function(){b.error(c.Error.DATABASE_ERROR,d.error||"Failed to execute transaction.")}}),b.error)},queryWithQuery:function(a,b){b=this._options(b),this._transaction([this.collection,m.QUERY_STORE],m.READ_ONLY,e(this,function(d){var f=[],g=this._getKey(a),h=d.objectStore(m.QUERY_STORE).get(g);h.onsuccess=e(this,function(){var a=h.result;if(a){var b=d.objectStore(this.collection);a.response.forEach(function(a){var c=b.get(a);c.onsuccess=function(){c.result&&f.push(c.result)}})}}),d.oncomplete=e(this,function(){if(h.result)if(b.resolve&&b.resolve.length){var a=f.length;f.forEach(e(this,function(c){this._resolve(c,b.resolve,function(){!--a&&b.success(f,{cached:!0})})}))}else b.success(f,{cached:!0});else b.error(c.Error.DATABASE_ERROR,"Query is not in database.")}),d.onabort=d.onerror=function(){b.error(c.Error.DATABASE_ERROR,d.error||"Failed to execute transaction.")}}),b.error)},remove:function(a,b){b=this._options(b);var d=[this.collection];!b.silent&&d.push(m.TRANSACTION_STORE),this._transaction(d,m.READ_WRITE,e(this,function(d){var f=d.objectStore(this.collection),g=f.get(a._id);g.onsuccess=e(this,function(){var c=g.result||a;f["delete"](c._id),!b.silent&&this._addTransaction(d.objectStore(m.TRANSACTION_STORE),c)}),d.oncomplete=function(){b.success(null,{cached:!0})},d.onabort=d.onerror=function(){b.error(c.Error.DATABASE_ERROR,d.error||"Failed to execute transaction.")}}),b.error)},removeWithQuery:function(a,b){this.queryWithQuery(a,f(b,{success:e(this,function(d){var f=[this.collection,m.QUERY_STORE];!b.silent&&f.push(m.TRANSACTION_STORE),this._transaction(f,m.READ_WRITE,e(this,function(e){var f=this._getKey(a);e.objectStore(m.QUERY_STORE)["delete"](f);var g=e.objectStore(this.collection);d.forEach(function(a){g["delete"](a._id)}),!b.silent&&this._addTransaction(e.objectStore(m.TRANSACTION_STORE),d),e.oncomplete=function(){b.success(null,{cached:!0})},e.onabort=e.onerror=function(){b.error(c.Error.DATABASE_ERROR,e.error||"Failed to execute transaction.")}}),b.error)})}))},save:function(a,b){b=this._options(b);var d=[this.collection];!b.silent&&d.push(m.TRANSACTION_STORE),this._transaction(d,m.READ_WRITE,e(this,function(d){var f=d.objectStore(this.collection);a._id||(a._id=this._getRandomId());var g=f.get(a._id);g.onsuccess=e(this,function(){var c=g.result;c&&(null==a._acl&&c._acl&&(a._acl=c._acl),null==a._kmd&&c._kmd&&(a._kmd=c._kmd)),d.objectStore(this.collection).put(a),!b.silent&&this._addTransaction(d.objectStore(m.TRANSACTION_STORE),a)}),d.oncomplete=function(){b.success(a,{cached:!0})},d.onabort=d.onerror=function(){b.error(c.Error.DATABASE_ERROR,d.error||"Failed to execute transaction.")}}),b.error)},multiQuery:function(a,b){b=this._options(b),this._transaction(this.collection,m.READ_ONLY,e(this,function(d){var e={},f=d.objectStore(this.collection);a.forEach(function(a){var b=f.get(a);b.onsuccess=function(){e[a]=b.result||null}}),d.oncomplete=function(){b.success(e,{cached:!0})},d.onabort=d.onerror=function(){b.error(c.Error.DATABASE_ERROR,d.error||"Failed to execute transaction.")}}),b.error)},multiRemove:function(a,b){b=this._options(b),this._transaction(this.collection,m.READ_WRITE,e(this,function(d){var e=d.objectStore(this.collection);a.forEach(function(a){e["delete"](a)}),d.oncomplete=function(){b.success(null,{cached:!0})},d.onabort=d.onerror=function(){b.error(c.Error.DATABASE_ERROR,d.error||"Failed to execute transaction.")}}),b.error)},put:function(a,b,c,d){d=f(d,{silent:!0});switch(a){case"aggregate":this._putAggregation(b,c,d);break;case"query":null!==c?this._putSave(c,d):this.remove(b,d);break;case"queryWithQuery":null!==c?this._putQueryWithQuery(b,c,d):this.removeWithQuery(b,d)}},_putAggregation:function(a,b,d){d=this._options(d),this._transaction(m.AGGREGATION_STORE,m.READ_WRITE,e(this,function(e){var f=e.objectStore(m.AGGREGATION_STORE),g=this._getKey(a);null!==b?f.put({aggregation:g,response:b}):f["delete"](g),e.oncomplete=function(){d.success(b)},e.onabort=e.onerror=function(){d.error(c.Error.DATABASE_ERROR,e.error||"Failed to execute transaction.")}}),d.error)},_putQueryWithQuery:function(a,b,d){d=this._options(d);var g=[],h=e(this,function(){this._transaction(m.QUERY_STORE,m.READ_WRITE,e(this,function(e){e.objectStore(m.QUERY_STORE).put({query:this._getKey(a),response:g}),e.oncomplete=function(){d.success(b)},e.onabort=e.onerror=function(){d.error(c.Error.DATABASE_ERROR,e.error||"Failed to execute transaction.")}}),d.error)}),i=b.length;if(0===b.length)return h();b.forEach(e(this,function(a){this.put("query",null,a,f(d,{success:function(a){g.push(a._id),!--i&&h()},error:function(){!--i&&h()}}))}))},_putSave:function(a,b){if(b.resolve&&b.resolve.length){this._extract(a,b.resolve,e(this,function(){this.save(a,f(b,{silent:!0}))}));return}this.save(a,f(b,{silent:!0}))},getTransactions:function(a){a=this._options(a),this._transaction(m.TRANSACTION_STORE,m.READ_ONLY,e(this,function(b){var d={},f=b.objectStore(m.TRANSACTION_STORE);if(m.TRANSACTION_STORE!==this.collection){var g=f.get(this.collection);g.onsuccess=e(this,function(){var a=g.result;a&&(d[this.collection]=a.transactions)})}else{var h=f.openCursor();h.onsuccess=function(){var a=h.result;if(a){var b=a.value;d[b.collection]=b.transactions,a["continue"]()}}}b.oncomplete=function(){a.success(d)},b.onabort=b.onerror=function(){a.error(c.Error.DATABASE_ERROR,b.error||"Failed to execute transaction.")}}),a.error)},removeTransactions:function(a,b){b=this._options(b),this._transaction(m.TRANSACTION_STORE,m.READ_WRITE,e(this,function(d){var f=d.objectStore(m.TRANSACTION_STORE),g=f.get(this.collection);g.onsuccess=e(this,function(){var b=g.result;b&&(a.forEach(function(a){delete b.transactions[a]}),Object.keys(b.transactions).length?f.put(b):f["delete"](this.collection))}),d.oncomplete=function(){b.success(a,{cached:!0})},d.onabort=d.onerror=function(){b.error(c.Error.DATABASE_ERROR,d.error||"Failed to execute transaction.")}}),b.error)},_addTransaction:function(a,b){b instanceof Array||(b=[b]);var c=a.get(this.collection);c.onsuccess=e(this,function(){var d=c.result||{collection:this.collection,transactions:{}};b.forEach(function(a){d.transactions[a._id]=a._kmd?a._kmd.lmt:null}),a.put(d)})},_extract:function(a,b,c){if(0===b.length)return c();b=this._flatten(b);var d=Object.keys(b),f=d.length;d.forEach(e(this,function(d){var g=a[d];if(g instanceof Object){if("KinveyRef"===g._type)if(null!=g._obj){var h=this.collection===g._collection?this:new m(g._collection);h.put("query",null,g._obj,{resolve:b[d],success:function(){delete g._obj,!--f&&c()},error:function(){delete g._obj,!--f&&c()}})}else delete g._obj,!--f&&c();else if(g instanceof Array){var i=g.length;g.forEach(e(this,function(a,e){this._extract({_:a},b[d].concat("_"),function(){!--i&&!--f&&c()})}))}else this._extract(g,b[d],function(){!--f&&c()});return}!--f&&c()}))},_flatten:function(a){var b={};return a.forEach(function(a){var c=a.split("."),d=c.shift();b[d]||(b[d]=[]),c[0]&&b[d].push(c.join("."))}),b},_resolve:function(a,b,c){if(0===b.length)return c();b=this._flatten(b);var d=Object.keys(b),f=d.length;d.forEach(e(this,function(d){var g=a[d];if(g instanceof Object){if("KinveyRef"===g._type){var h=this.collection===g._collection?this:new m(g._collection);h.query(g._id,{resolve:b[d],success:function(a){g._obj=a,!--f&&c()},error:function(){g._obj=null,!--f&&c()}})}else if(g instanceof Array){var i=g.length;g.forEach(e(this,function(a,e){var h={x:a};this._resolve(h,b[d].concat("x"),function(){g[e]=h.x,!--i&&!--f&&c()})}))}else this._resolve(g,b[d],function(){!--f&&c()});return}!--f&&c()}))},_getRandomId:function(){return(new Date).getTime().toString()+Math.random().toString(36).substring(2,12)},_getKey:function(a){return a.collection=this.collection,JSON.stringify(a)},_getSchema:function(a){var b={};return b[m.TRANSACTION_STORE]="collection",b[m.AGGREGATION_STORE]="aggregation",b[m.QUERY_STORE]="query",{name:a,options:{keyPath:b[a]||"_id"}}},_mutate:function(a,b,c){this._open(null,null,e(this,function(d){var e=parseInt(d.version||0,10)+1;this._open(e,a,b,c)}),c)},_open:function(a,b,d,f){var g=d;d=e(this,function(a){if(m.isIdle){var b=m.queue.shift();b&&this._open.apply(this,b)}g(a)});if(null!=m.instance&&(null==a||m.instance.version===a))return d(m.instance);if(!m.isIdle)return m.queue.push(arguments);m.isIdle=!1;var h;if(m.instance&&m.instance.setVersion){h=m.instance.setVersion(a),h.onsuccess=function(){b(m.instance);var a=h.result;a.oncomplete=function(){m.isIdle=!0,d(m.instance)}},h.onblocked=h.onerror=function(){f(c.Error.DATABASE_ERROR,h.error||"Mutation error.")};return}null==a?h=k.open(this.name):h=k.open(this.name,a),h.onupgradeneeded=function(){m.instance=h.result,b&&b(m.instance)},h.onsuccess=e(this,function(){m.instance=h.result,m.instance.onversionchange=function(){m.instance&&(m.instance.close(),m.instance=null)},m.isIdle=!0,d(m.instance)}),h.onblocked=h.onerror=function(){f(c.Error.DATABASE_ERROR,"Failed to open the database.")}},_options:function(a){a||(a={});var b=a.error||function(){};return a.error=function(a,c){b({error:a,description:c||a,debug:""},{cached:!0})},a.success||(a.success=function(){}),a},_transaction:function(a,b,c,d){!(a instanceof Array)&&(a=[a]),this._open(null,null,e(this,function(f){var g=[];a.forEach(function(a){f.objectStoreNames.contains(a)||g.push(a)}),0!==g.length?this._mutate(e(this,function(a){g.forEach(e(this,function(b){if(!a.objectStoreNames.contains(b)){var c=this._getSchema(b);a.createObjectStore(c.name,c.options)}}))}),function(d){c(d.transaction(a,b))},d):c(f.transaction(a,b))}),d)}},{READ_ONLY:l.READ_ONLY||"readonly",READ_WRITE:l.READ_WRITE||"readwrite",AGGREGATION_STORE:"_aggregations",QUERY_STORE:"_queries",TRANSACTION_STORE:"_transactions",isIdle:!0,queue:[],instance:null});c.Store.Cached=d.extend({name:c.Store.CACHED,options:{policy:null,store:{},success:function(){},error:function(){},complete:function(){}},constructor:function(a,b){this.collection=a,this.db=new m(a),this.store=c.Store.factory(c.Store.APPDATA,a),this.options.policy=c.Store.Cached.NETWORK_FIRST,b&&this.configure(b)},aggregate:function(a,b){b=this._options(b),this._read("aggregate",a,b)},configure:function(a){a.policy&&(this.options.policy=a.policy),a.store&&(this.options.store=a.store),a.success&&(this.options.success=a.success),a.error&&(this.options.error=a.error),a.complete&&(this.options.complete=a.complete)},login:function(a,b){b=this._options(b),this.store.login(a,b)},logout:function(a,b){b=this._options(b),this.store.logout(a,b)},query:function(a,b){b=this._options(b),this._read("query",a,b)},queryWithQuery:function(a,b){b=this._options(b),this._read("queryWithQuery",a,b)},remove:function(a,b){b=this._options(b),this._write("remove",a,b)},removeWithQuery:function(a,b){b=this._options(b),this._write("removeWithQuery",a,b)},save:function(a,b){b=this._options(b),this._write("save",a,b)},_options:function(a){return a||(a={}),a.policy||(a.policy=this.options.policy),this.store.configure(a.store||this.options.store),a.success||(a.success=this.options.success),a.error||(a.error=this.options.error),a.complete||(a.complete=this.options.complete),a},_read:function(a,b,c){var d=this._shouldCallNetworkFirst(c.policy),g=d?this.store:this.db,h=d?this.db:this.store,i=!1,j=c.success;c.success=e(this,function(d,e){var g=i;if(!i||this._shouldCallBothCallbacks(c.policy))i=!0,j(d,e);if(e.network&&this._shouldUpdateCache(c.policy)){var h=function(){c.complete()};this.db.put(a,b,d,f(c,{success:h,error:h}))}else(g||!this._shouldCallBoth(c.policy))&&c.complete()}),g[a](b,f(c,{success:e(this,function(d,e){c.success(d,e),this._shouldCallBoth(c.policy)&&(c.error=function(){c.complete()},h[a](b,c))}),error:e(this,function(d,e){if(this._shouldCallFallback(c.policy)){var f=c.error;c.error=function(a,b){f(a,b),c.complete()},h[a](b,c)}else c.error(d,e),c.complete()})}))},_shouldCallBoth:function(a){var b=[c.Store.Cached.CACHE_FIRST,c.Store.Cached.BOTH];return-1!==b.indexOf(a)},_shouldCallBothCallbacks:function(a){return c.Store.Cached.BOTH===a},_shouldCallFallback:function(a){var b=[c.Store.Cached.NETWORK_FIRST];return this._shouldCallBoth(a)||-1!==b.indexOf(a)},_shouldCallNetworkFirst:function(a){var b=[c.Store.Cached.NO_CACHE,c.Store.Cached.NETWORK_FIRST];return-1!==b.indexOf(a)},_shouldUpdateCache:function(a){var b=[c.Store.Cached.CACHE_FIRST,c.Store.Cached.NETWORK_FIRST,c.Store.Cached.BOTH];return-1!==b.indexOf(a)},_write:function(a,b,c){var d=c.error,f=c.success;c.success=e(this,function(d,e){f(d,e);if(this._shouldUpdateCache(c.policy)){var g={remove:["query",b,null],removeWithQuery:["queryWithQuery",b,null]};"user"!==this.collection&&null!=d&&(g.save=["query",d._id,d]);if(g[a]){g[a].push({success:function(){c.complete()},error:function(){c.complete()}}),this.db.put.apply(this.db,g[a]);return}}c.complete()}),c.error=function(a,b){d(a,b),c.complete()},this.store[a](b,c)}},{NO_CACHE:"nocache",CACHE_ONLY:"cacheonly",CACHE_FIRST:"cachefirst",NETWORK_FIRST:"networkfirst",BOTH:"both"}),c.Store.Offline=c.Store.Cached.extend({name:c.Store.OFFLINE,constructor:function(a,b){if(c.Store.AppData.USER_API===a)throw new Error("The User API cannot be used with OfflineStore");c.Store.Cached.prototype.constructor.call(this,a,b)},configure:function(a){c.Store.Cached.prototype.configure.call(this,a),a.conflict&&(this.options.conflict=a.conflict)},remove:function(a,b){b=this._options(b),this.db.remove(a,this._wrap(a,b))},removeWithQuery:function(a,b){b=this._options(b),this.db.removeWithQuery(a,this._wrap(null,b))},save:function(a,b){b=this._options(b),this.db.save(a,this._wrap(a,b))},_options:function(a){return a=c.Store.Cached.prototype._options.call(this,a),c.Sync.isOnline||(a.policy=c.Store.Cached.CACHE_ONLY),a},_wrap:function(a,b){return f(b,{success:e(this,function(d){b.success(d,{offline:!0});var e={conflict:b.conflict,success:b.complete,error:b.complete};if(a)return c.Sync.object(this.collection,d||a,e);c.Sync.collection(this.collection,e)}),error:function(a){b.error(a,{offline:!0}),b.complete()}})}}),c.Sync={isOnline:navigator.onLine,options:{conflict:null,store:{},start:function(){},success:function(){},error:function(){}},configure:function(a){a.conflict&&(c.Sync.options.conflict=a.conflict),a.store&&(c.Sync.options.store=a.store),a.start&&(c.Sync.options.start=a.start),a.success&&(c.Sync.options.success=a.success),a.error&&(c.Sync.options.error=a.error)},offline:function(){c.Sync.isOnline=!1},online:function(){c.Sync.isOnline||(c.Sync.isOnline=!0,c.Sync.application())},application:function(a){a=c.Sync._options(a),c.Sync.isOnline?(new n(a)).application({start:c.Sync.options.start||function(){}}):a.error({error:c.Error.NO_NETWORK,description:"There is no active network connection.",debug:"Synchronization requires an active network connection."})},collection:function(a,b){b=c.Sync._options(b),c.Sync.isOnline?(new n(b)).collection(a):b.error({error:c.Error.NO_NETWORK,description:"There is no active network connection.",debug:"Synchronization requires an active network connection."})},object:function(a,b,d){d=c.Sync._options(d),c.Sync.isOnline?(new n(d)).object(a,b):d.error({error:c.Error.NO_NETWORK,description:"There is no active network connection.",debug:"Synchronization requires an active network connection."})},clientAlwaysWins:function(a,b,c,d){d.success(b)},ignore:function(a,b,c,d){d.error()},serverAlwaysWins:function(a,b,c,d){d.success(c)},_options:function(a){return a||(a={}),a.store||(a.store=c.Sync.options.store),a.conflict||(a.conflict=c.Sync.options.conflict||c.Sync.ignore),a.success||(a.success=c.Sync.options.success),a.error||(a.error=c.Sync.options.error),a}},window.addEventListener("online",c.Sync.online,!1),window.addEventListener("offline",c.Sync.offline,!1);var n=d.extend({constructor:function(a){this.store=a.store,this.conflict=a.conflict,this.success=a.success,this.error=a.error},application:function(a){a&&a.start&&a.start(),(new m(m.TRANSACTION_STORE)).getTransactions({success:e(this,function(a){var b={},c=Object.keys(a),d=c.length;if(0===d)return this.success(b);var f=e(this,function(a){return e(this,function(c){c&&(b[a]=c),!--d&&this.success(b)})});c.forEach(e(this,function(b){this._collection(b,a[b],f(b))}))}),error:this.error})},collection:function(a){(new m(a)).getTransactions({success:e(this,function(b){if(null==b[a])return this.success({});this._collection(a,b[a],e(this,function(b){var c={};b&&(c[a]=b),this.success(c)}))}),error:this.error})},object:function(a,b){var d=b._id,f=new m(a);f.getTransactions({success:e(this,function(b){if(null==b[a]||!b[a].hasOwnProperty(d))return this.success({});var g=b[a][d];b={},b[d]=g,this._classifyAndCommit(a,b,{db:f,objects:[d],store:c.Store.factory(c.Store.APPDATA,a,this.store)},e(this,function(b){var c={};c[a]=b,this.success(c)}))}),error:this.error})},_classify:function(a,b,c,d){this._retrieve(c.objects,c,e(this,function(f,g){var h={},i=[],j=c.objects.length,k=function(a){return{success:function(b){b&&(b._id=a),h[a]=b,!--j&&d(h,i,[])},error:function(b,c,e){i.push(a),!--j&&d(h,i,[])}}};g.forEach(e(this,function(c){var d=c._id;this._object(a,b[d],f[d],c,k(d)),delete f[d]})),Object.keys(f).forEach(e(this,function(c){this._object(a,b[c],f[c],null,k(c))}))}),function(){d([],[],c.objects)})},_classifyAndCommit:function(a,b,c,d){this._classify(a,b,c,e(this,function(a,b,e){this._commit(a,c,function(a,c){d({committed:a,conflicted:b,canceled:e.concat(c)})})}))},_collection:function(a,b,d){var e=Object.keys(b);if(0===e.length)return d();this._classifyAndCommit(a,b,{db:new m(a),objects:e,store:c.Store.factory(c.Store.APPDATA,a,this.store)},d)},_commit:function(a,b,c){b.objects=Object.keys(a);if(0===b.objects.length)return c([],[]);var d=[],e=[];b.objects.forEach(function(b){var c=a[b];null!=c?d.push(c):e.push(b)});var f=[],g=[],h=2,i=function(a,d){f=f.concat(a),g=g.concat(d);if(!--h){var e=function(){c(f,g)};b.db.removeTransactions(f,{success:e,error:e})}};this._commitUpdates(d,b,i),this._commitRemovals(e,b,i)},_commitObject:function(a,b,c){b.store.save(a,{success:function(a){var d=function(){c([a._id],[])};b.db.put("query",a._id,a,{success:d,error:d})},error:function(){c([],[a._id])}})},_commitRemovals:function(a,b,d){if(0===a.length)return d([],[]);var e=function(){var c=function(){d(a,[])};b.db.multiRemove(a,{success:c,error:c})},f=(new c.Query).on("_id").in_(a);b.store.removeWithQuery(f.toJSON(),{success:e,error:function(){d([],a)}})},_commitUpdates:function(a,b,c){if(0===a.length)return c([],[]);var d=[],f=[],g=a.length,h=function(a,b){d=d.concat(a),f=f.concat(b),!--g&&c(d,f)};a.forEach(e(this,function(a){this._commitObject(a,b,h)}))},_object:function(a,b,c,d,e){if(null===d||b===d._kmd.lmt)return e.success(c);this.conflict(a,c,d,{success:e.success,error:function(){e.error(a,c,d)}})},_retrieve:function(a,b,d,e){var f=[],g=[],h=2,i=function(){return{success:function(a,b){b.network?g=a:f=a,!--h&&d(f,g)},error:function(){e(),e=function(){}}}},j=(new c.Query).on("_id").in_(a);b.store.queryWithQuery(j.toJSON(),i()),b.db.multiQuery(a,i())}})}).call(this);